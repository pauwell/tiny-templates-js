<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>TinyTemplatesJs</title>
  <style>
    .test-shop{
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.3em;
      display: flex;
      justify-content: space-evenly;
      align-items: baseline;
    }
    .test-shop > fieldset{
      background: lightgray;
      width: 30%;
    }
    .cart-product{
      width: 100px; 
      float: left;
      background: lightgray;
    }
    .cart-price{
      width: fit-content;
      float: left
    }
    dialog{
      border: 2px solid white;
      border-radius: 3px;
      background: gray;
      color: white;
    }
    dialog > button{
      float: right;
    }
  </style>
  <script src="tiny_helper.js"></script>
  <script src="tiny_state.js"></script>
  <script src="tiny_template-0.4.js"></script>
  <script>
    /* Test shop template. */
    class TestShop extends TinyTemplate{
      constructor(parent, name, state){
        super(parent, name, state);
      }
      buy(product, price){
        this.setState({cartItems: this.getState('cartItems').concat({product: product, price: price})});
        this.calculateTotalPrice();
      }
      calculateTotalPrice(){
        let price = 0;
        this.getState('cartItems').forEach((product) => {
          price += product.price;
        });
        this.setState({priceTotal: price});
      }
      checkout(){
        document.getElementById('checkout-dialog').showModal();
      }
      removeItem(index){
        let tmp = this.getState('cartItems');
        tmp.splice(index, 1);
        console.log(tmp);
        this.setState({cartItems: tmp});
        this.calculateTotalPrice(); 
      }
      removeAllItems(){
        this.setState({cartItems: []});
        this.calculateTotalPrice();
      }
      updateName(event){
        this.setState({name: event.target.value});
      }
    }
  </script>
</head>
<body>
  <!-- Application entry -->
  <h1>TinyTemplatesJS</h1>
  <fieldset>
    <legend><em>Test Shop</em></legend>
    <div id="app"></div>
  </fieldset>

  <!-- Example template -->
  <script type="text/x-template" id="test-shop">
    <div class="test-shop"> 
      <fieldset class="buy">
        <legend><h3>Buy</h3></legend>
        <ul>
          <li>Apple 1$ <button onclick="testShop.buy('Apple', 1)">+</button></li>
          <li>Banana 2$ <button onclick="testShop.buy('Banana', 2)">+</button></li>
          <li>Orange 4$ <button onclick="testShop.buy('Orange', 4)">+</button></li>
        </ul>
      </fieldset>
      <fieldset class="cart">
        <legend><h3>Cart</h3></legend>
        :for(fruit in this.getState('cartItems'))
          <div class="cart-product">:take(fruit.product)</div>
          <div class="cart-price">:take(fruit.price)$</div>
          <button onclick="testShop.removeItem(:take(idx))">-</button>
          <br>
        :rof
        <br>
        <div>
          <hr>Total <b>:js(this.getState('priceTotal'))$</b>
          <button onclick="testShop.removeAllItems()">Alle entfernen</button>
        </div>
      </fieldset>
      <fieldset class="checkout">
        <legend><h3>Checkout</h3></legend>
        <label>Payment method</label><br>
        <input type="radio" value="visa" name="pay" onchange="testShop.setState({payment: 'visa'})" checked>Visa<br>
        <input type="radio" value="master" name="pay" onchange="testShop.setState({payment: 'master'})">Mastercard<br>
        :if(this.getState('payment') === 'visa')
          <h3>VISA</h3>
          <p>Enter visa credentials here:</p>
          <input type="text" placeholder="visa" name="credit" oninput="testShop.updateName(event)">
        :fi
        :if(this.getState('payment') === 'master')
        <h3>MASTER</h3>
          <p>Enter master credentials here:</p>
          <input type="text" placeholder="master" name="credit" oninput="testShop.updateName(event)">
        :fi
        <button onclick="testShop.checkout()">Checkout</button>
        <dialog id="checkout-dialog">
          <button onclick="this.parentElement.close()">X</button>
          <h3>Thank you for using TinyTemplateJs.</h3>
          <p>This is a checkout...</p>
          <p>You have to pay: <h3>[:js(this.getState('priceTotal'))$]</h3></p>
          <ul>
            <li>Payment method: :js(this.getState('payment'))</li>
            <li>Name: :js(this.getState('name'))</li>
          </ul>
        </dialog>
      </fieldset>
    </div>
  </script>

  <!-- Instantiate & parse -->
  <script>    
    let appNode = document.getElementById('app');
    let testShop = new TestShop(appNode, 'test-shop', {name: '', cartItems: [], payment: 'visa', priceTotal: 0});
  </script>
</body>
</html>