<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>TinyTemplatesJs</title>
  <style>
    .base-template{
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.3em;
    }
    .base-template > fieldset{
      background: lightgray;
    }
    .cart-product{
      width: 100px; 
      float: left;
      background: lightgray;
    }
    .cart-price{
      width: fit-content;
      float: left
    }
    dialog{
      border: 2px solid white;
      border-radius: 3px;
      background: gray;
      color: white;
    }
    dialog > button{
      float: right;
    }
  </style>
  <script src="tiny_helper.js"></script>
  <script src="tiny_state.js"></script>
  <script src="tiny_template-0.3.js"></script>
  <script>
    /* Example template. */
    class BaseTemplate extends TinyTemplate{
      constructor(parent, name, state, stringTemplate=null){
        super(parent, name, state, stringTemplate);
      }
      buy(product, price){
        this.setState({cartItems: this.getState('cartItems').concat({product: product, price: price})});
        this.calculateTotalPrice();
      }
      calculateTotalPrice(){
        let price = 0;
        this.getState('cartItems').forEach((product) => {
          price += product.price;
        });
        this.setState({priceTotal: price});
      }
      checkout(){
        document.getElementById('checkout-dialog').showModal();
      }
      removeItem(index){
        let tmp = this.getState('cartItems');
        tmp.splice(index, 1);
        console.log(tmp);
        this.setState({cartItems: tmp});
        this.calculateTotalPrice(); 
      }
      updateName(event){
        this.setState({name: event.target.value});
      }
    }

    /* Small counter example. */
    class CounterTemplate extends TinyTemplate{
      constructor(parent, name, state, stringTemplate=null){
        super(parent, name, state, stringTemplate);
      }
    }
  </script>
</head>
<body>
  <!-- Application entry -->
  <h1>TinyTemplatesJS</h1>
  <fieldset>
    <legend><em>Example Shop</em></legend>
    <div id="app"></div>
  </fieldset>

  <!-- Example template -->
  <script type="text/x-template" id="base-template">
    <div class="base-template"> 
      <fieldset class="buy">
        <legend><h3>Buy</h3></legend>
        <ul>
          <li>Apple 1$ <button onclick="baseTemplate.buy('Apple', 1)">+</button></li>
          <li>Banana 2$ <button onclick="baseTemplate.buy('Banana', 2)">+</button></li>
          <li>Orange 4$ <button onclick="baseTemplate.buy('Orange', 4)">+</button></li>
        </ul>
      </fieldset>
      <fieldset class="cart">
        <legend><h3>Cart</h3></legend>
        :js(this.getState('cartItems').length > 0 
          ? this.getState('cartItems').map((e, idx, arr) => `
            <div class="cart-product">
              ${e.product}
            </div>
            <div class="cart-price">
              ${e.price}$ 
            </div>
            <button onclick="baseTemplate.removeItem(${idx})">-</button>
              `).join('<br>')
          : 'Empty')
        <br>
        <div><hr>Total <b>:js(this.getState('priceTotal'))$</b></div>
      </fieldset>
      <fieldset class="checkout">
        <legend><h3>Checkout</h3></legend>
        <label>Payment method</label><br>
        <input type="radio" value="visa" name="pay" onchange="baseTemplate.setState({payment: 'visa'})" checked>Visa<br>
        <input type="radio" value="master" name="pay" onchange="baseTemplate.setState({payment: 'master'})">Mastercard<br>
        :if(this.getState('payment') === 'visa')
          <h3>VISA</h3>
          <p>Enter visa credentials here:</p>
          <input type="text" placeholder="visa" oninput="baseTemplate.updateName(event)">
        :fi
        :if(this.getState('payment') === 'master')
        <h3>MASTER</h3>
          <p>Enter master credentials here:</p>
          <!-- @Todo: Bind this.getState('name') to the following input: -->
          <input type="text" name="credit" oninput="baseTemplate.updateName(event)">
        :fi
        <button onclick="baseTemplate.checkout()">Checkout</button>
        <dialog id="checkout-dialog">
          <button onclick="this.parentElement.close()">X</button>
          <h3>Thank you for using TinyTemplateJs.</h3>
          <p>This is a checkout...</p>
          <p>You have to pay: <h3>[:js(this.getState('priceTotal'))$]</h3></p>
          <ul>
            <li>Payment method: :js(this.getState('payment'))</li>
            <li>Name: :js(this.getState('name'))</li>
          </ul>
        </dialog>
      </fieldset>
    </div>
  </script>

  <!-- Instantiate & parse -->
  <script>    
    let appNode = document.getElementById('app');
    let baseTemplate = new BaseTemplate(appNode, 'base-template', {name: '', cartItems: [], payment: 'visa', priceTotal: 0});
  </script>
</body>
</html>